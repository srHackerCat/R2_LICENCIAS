/*!
* Restful.js - RESTful Level 3 Client API
* Copyright 2022 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function u(n,t,i,r){return{error:{errors:[{id:"00000000-0000-0000-0000-000000000001",reason:i,message:r.message||r}],code:n,message:t}}}var t=typeof $app=="undefined"?null:$app,f=window,n={},i,r;(t||(f.$app=t={}),r=t.restful,!r||r._unresolved)&&(r=t.restful=function(f){var h,c,a,l,p,v,o,s,e,y;if(f||(f={url:null,method:"GET",body:null}),h=f.config,c=f.query,n=h||n,!h||(i=h.baseUrl||i,Object.keys(f).length!==1)){if(!i&&(i=typeof __baseUrl=="undefined"?null:__baseUrl,!i))for(a=document.getElementsByTagName("script"),l=0;l<a.length;l++)if(p=a[l],v=(p.getAttribute("src")||"").match(/^(.+?)(\/v\d\/js|\/js\/sys)\/restful.*?\.js/),v){i=v[1];break}if(o=f.token||(f.token!==!1&&n.token?typeof n.token=="function"?n.token():n.token:null),s=typeof o=="string"?o:o&&typeof o=="object"?o.access_token:null,!s&&t.AccountManager&&(o=t.AccountManager.current(),o&&(s=o.access_token)),f.url&&f.url.href&&(f.method=f.url.method,f.url=f.url.href),e=f.url||"/v2",!e.match(/^http/)&&i&&(e.match(/^\//)||(e="/"+e),i!="/"&&(e=i+e)),c){e=[e];for(y in c)e.push(e.length===1?e[0].match(/\?|#/)?"&":"?":"&",y,"=",encodeURIComponent(c[y]));e=e.join("")}return new Promise((i,h)=>{function lt(n){f.token=n;r(f).then(n=>{i&&i(n)}).catch(w)}function w(n){h&&h(n.error||n)}var a=new Headers,d=f.method||"GET",c=f.hypermedia,g,ut,b,ht,nt,v,l,p,tt,ft,et,it,ct,ot,k,st,y,rt;if(s&&a.append("Authorization","Bearer "+s),a.append("Accept",f.accept||"application/json"),d!=="GET"&&a.append("Content-Type",f.contentType||"application/json"),f.headers)for(ut in f.headers)a.append(ut,f.headers[ut]);if(f.schema&&(g="true"),f.schemaOnly&&(g="only"),g&&a.append("X-Restful-Schema",g),c===!1&&a.append("X-Restful-Hypermedia","false"),typeof c=="string"&&c.length&&(b=c.match(/^(.+?)(\s*(>>)\s*(.*))?$/),b&&(c={name:b[1],transition:!!b[3],next:b[4]},c.transition))){for(v in["body","query","headers","files"])delete f[v];ht=new RegExp(RegExp("^"+c.name+"\\s*>>"));for(v in f)if(v.match(ht)){if(nt=f[v],nt)for(v in nt)f[v]=nt[v];break}}if(l=f.body,y=f.etag,l&&typeof l=="object"){y===!0&&(tt=l._links,y=tt&&tt.self&&tt.self.etag);for(ft in l)et=l[ft],et instanceof Blob&&(p||(p=[]),p.push({f:ft,v:et}));p&&(p.forEach(n=>delete l[n.f]),a.delete("Content-Type"));l=JSON.stringify(l)}typeof y=="string"&&a.append("If-Match",y);p&&(it=new FormData,it.set("",new Blob([l],{type:"application/json"}),""),p.forEach(n=>it.set(n.f,n.v,n.v.name||"")),l=it);ct={method:d,headers:a,body:d==="GET"?null:l,redirect:"follow"};fetch(e,ct).then(function(n){return ot=n.status,k=n.headers.get("Content-Type"),st=n.headers.get("Content-Disposition"),y=n.headers.get("ETag"),rt=ot!==401&&k.match(/^(application\/(json|x-yaml|xml)|text\/(yaml|x-yaml|xml))/),rt?n.text():n.arrayBuffer()}).then(s=>{var h,l,a;if(ot===401)o&&o.refresh_token?t.refreshUserToken?t.refreshUserToken(o,()=>{lt(t.AccountManager.current())}):r({url:"/oauth2/v2/token",method:"POST",body:{grant_type:"refresh_token",client_id:n.clientId,refresh_token:o.refresh_token},token:!1}).then(t=>{var i,r;if(typeof n.token=="function"){if(i=n.token(),typeof i=="object")for(r in t)i[r]=t[r];n.token(i)}f.token=t;lt(t)}).catch(w):w(u(401,"Unauthorized","access_denied","Invalid acces token or API key is specified."));else if(i)if(rt&&k.match(/^application\/json/))if(s!=null&&s.length||(s="{}"),s=JSON.parse(s),s&&s.error)s.error._schema=s._schema,w(s.error);else{if(y&&s._links&&(h=s._links.self,h&&(h.etag=y)),c&&c.name)if(s=s._links?s._links[c.name]:null,s==null)w(u(400,"Bad Request","invalid_hypermedia","Hypermedia '"+c[1]+"' not found in "+d+" "+e+" response."));else if(c.transition){f.url=s;f.hypermedia=c.next;r(f).then(n=>{i(n)}).catch(w);return}c===!0&&(s=s._links||{});i(s||{})}else rt||(l="file."+(k.split(";")[0]||"/dat").split(/\//)[1],st&&(a=st.match(/filename=(.+?)(;|$)/),a&&(l=a[1])),s=new Blob([s],{type:k}),s.name=l),i(s)}).catch(n=>{w(u(400,"Bad Request","error",n))})})}})})();