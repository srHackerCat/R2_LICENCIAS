/*!
* Touch UI - Property Grid
* Copyright 2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function s(n,i){if(u||(u=t.userVar("propCollapsed")||{}),arguments.length===2)i===null?delete u[n]:u[n]=i,t.userVar("propCollapsed",u);else return u[n]}function v(n){var f=[],u=n.properties,r,i;for(r in u)i=u[r],i.parent=n,i.name||(i.name=r),i.text||(i.text=t.prettyText(r,!0)),i.type||(i.type="text"),i.type!=="text"||"length"in i||(i.length=255),i.type==="bool"&&(i.style||(i.style="DropDownList")),i.values&&!i.style&&(i.style="DropDownList"),!i.style||"required"in i||(i.required=!0),i.type==="bool"&&i.style==="DropDownList"&&i.required&&(i.values=it),f.push(r),i.properties&&v(i);u._names=f.sort()}function rt(n){var t={};return t.flow=n.flow||"merge",t}function y(){var t=[];n.activePage("[data-layout]").data("rootNodes")[0].children.forEach(function(n){n.ready||t.push(n)});t.length&&n.layout({controls:t})}function p(){var t=n.scrollable();t.find(".app-stub").css("height",c(t).height)}function w(){var r=n.scrollable(),u=c(r),i=r.find(".app-stub"),f=c(i);t.intersect(u,f)?i.css("height",u.bottom-f.top+1):i.css("height","")}function h(){var i=$(this).closest("[data-property]"),o=i.data("property")+"_",r=!i.is(".app-collapsed"),t=i.next(),e=[],u,f;for(p(r),s(i.data("scope")+"$"+i.data("property"),r==!0?null:r),i.toggleClass("app-collapsed",r);t.length&&(t.data("property")||"").startsWith(o);)t.is(".app-collapsed")&&e.push(t.data("property")),r?t.addClass("app-collapsed-prop"):(u=t.data("property"),f=!1,e.forEach(function(n){u.startsWith(n)&&u.length>n.length&&(f=!0)}),f||t.removeClass("app-collapsed-prop")),t=t.next();return r||y(),n.hasFocus(i.find('[data-control="field"]')),w(),!1}function b(t){n.scrollIntoView(t);n.activePage(".app-has-focus").removeClass("app-has-focus");t.addClass("app-has-focus");n.activePage().removeData("last-focused-field");var i=d(t);k(i.text,i.description,!1)}function k(t,i,r){var u=n.activePage().data("infoPane");u.find(".app-text").text(t);u.find(".app-description").html(i||"");u.find(".app-help").css("display",r?"":"none")}function d(n){var t=n.closest("[data-property]"),i,r;return t.length||(t=n.closest("[data-category]")),r=t.data("scope"),i=t.data("category-name")||t.data("category"),e[r][i]}function g(n){var i=d(n),r=n.closest("[data-property]"),u=r.data("property")||"",t=i;return u.split(/_/).forEach(n=>t=t.properties[n]),t}function f(){return n.dataView().data("survey")}var t=$app,r=t.input,n=t.touch,nt=$(document),tt=Web.DataViewResources,a=tt.Data.BooleanDefaultItems,c=t.clientRect,it=[{value:!0,text:a[1][1]},{value:!1,text:a[0][1]}],e={},u,i=t.html,ut=i.tag,ft=i.div,et=i.span,ot=i.$tag,st=i.$p,o=i.$div,l=i.$span,ht=i.$a,ct=i.$i,lt=i.$li,at=i.$ul;n.propSet=function(n){var r;if(!n._registed){for(r in n){var i=n[r],f=i.scope,u=e[f];u||(u=e[f]={_names:[]});u[r]=i;u._names.push(r);i.name||(i.name=r);i.text||(i.text=t.prettyText(r,!0));v(i)}n._registed=!0}};n._propGrid=function(i,r){function u(){var n=arguments,u=1,t=arguments[0],r,i=[];for((n.length===1||n.length>1&&!(n[0]==="categories"||n[0]==="props"))&&(u=0,t="all"),r=u;r<n.length;r++)i.push(n[r]);i=i.join("");(t==="categories"||t==="all")&&v.push(i);(t==="props"||t==="all")&&w.push(i)}function p(n,i,r,f,e){var o={name:(r?r+"_":"")+i.name,type:i.type,text:i.text,options:{}},c,h;i.required&&(o.required=!0);i.style&&(o.items={style:i.style},i.values&&(o.items.list=[],i.values.forEach(function(n){typeof n=="string"&&(n={value:n,text:t.prettyText(n,!0)});o.items.list.push(n)})),i.style==="DropDownList"&&o.required&&(o.options.lookup={nullValue:!1}));c=!1;i.properties&&(c=s(n.scope+"$"+o.name),c==null&&(c=!0));a.push(o);h=[];l&&h.push("app-collapsed-cat");i.properties&&h.push("app-complex");c&&h.push("app-collapsed");e&&h.push("app-collapsed-prop");u('<div data-container="row" ','data-property="',o.name,'"','data-category-name="',n.name,'" ','data-scope="',n.scope,'" ',h.length?'class="'+h.join(" ")+'" ':"",f?'data-depth="'+f+'"':"",">");u('<span data-draggable="propgrid-divider"><\/span>');u('<span data-control="label" data-field="',o.name,'">',o.name,"<\/span>");u('<span data-control="field" data-field="',o.name,'"',i.style==="DropDownList"&&!1?' data-select-on-focus="false"':"",">[",o.name,"]<\/span>");i.properties&&u('<span class="app-toggle"><\/span>');u("<\/div>");i.properties&&i.properties._names.forEach(function(t){var r=i.properties[t];p(n,r,o.name,f+1,c||e)})}var f=r.propSet,o=r.use,a=[],v=[],w=[],h=[],y={},c,l;if(r.context||(r.context="generic"),typeof o=="string"&&(o=o.split(/\s*,\s*/)),f&&(Array.isArray(f)||(f=[f]),f.forEach(function(t){n.propSet(t)})),o.forEach(function(n){var t=e[n],i;if(t){h=h.concat(t._names);for(i in t)y[i]=t[i]}else c="Unknown property set "+n}),c){n.notify(c);return}u('<div data-layout="form" data-layout-size="tn">');u('<div data-container="simple">');h.sort().forEach(function(n){var i=y[n];l=s(i.scope+"$"+i.name);u('<div data-container="row" ','data-category="',n,'" ','data-scope="',i.scope,'" ','class="',l?"app-collapsed":"",'"',">");u('<span class="app-toggle"><\/span>');u('<span class="app-cat-text">',t.htmlEncode(i.text),"<\/span>");u("<\/div>");i.properties._names.forEach(function(n){var t=i.properties[n];p(i,t,"",0,!1)})});u('<div data-container="row">');u("<\/div>");u("<\/div>");u("<\/div>");t.survey({context:r,values:rt(r.target),questions:a,options:{modal:{dock:r.location||"right",max:"xxs",gap:!1,tapOut:!0,background:"transparent",title:!1},actionButtons:!1,discardChangesPrompt:!1,className:"app-propgrid"},layout:v.join("\n"),init:"propgridinit.app"});return};nt.on("vclick",".app-propgrid [data-category]",function(t){var i=$(this),f=i.data("category"),r=!i.is(".app-collapsed"),u=i.next();if(b(i),p(r),$(t.target).is(".app-toggle")||n.dblClick(i)){for(s(i.data("scope")+"$"+f,r===!1?null:r),i.toggleClass("app-collapsed",r);u.length&&u.data("category-name")===f;)u.toggleClass("app-collapsed-cat",r),u=u.next();r||y()}return w(r),!1}).on("vclick",".app-propgrid [data-property].app-complex .app-toggle",h).on("vdblclick",'.app-propgrid [data-property].app-complex [data-control="label"]',h).on("vdblclick",'.app-propgrid [data-property] [data-control="label"]',function(){var t=$(this),i=r.elementToField(t);i&&i.ItemsStyle==="DropDownList"&&setTimeout(function(){$(".app-data-input").blur();n.hasFocus(t);n.scrollable("focus")},150)}).on("datainputfocus.app",".app-propgrid",function(n){for(var e=n.dataInput.data("field"),o=f().context,r=g(n.dataInput),i=r.parent,u=[r.text];i;)i.parent&&u.splice(0,0,i.text),i=i.parent;t.userVar("PropGrid.LastSelected",o+"$"+e);k(u.join(" / "),r.description,!0)}).on("datainputlabel.app",'.app-propgrid [data-control="label"]',function(t){var i=t.dataInput.closest("[data-property]");if(i.length&&(propertyScope=i.data("scope"),n.hasFocus(i.find('[data-control="field"]')),n.scrollIntoView($(this)),n.saveLastFocusedField(i.data("property")),!t.dblClick||i.is(".app-complex")))return!1}).on("scrollablepageready.app",".app-propgrid",function(){}).on("pageautofocus.app",".app-propgrid",function(n){if(!n.reverse)return!1}).on("datainputmove.app",".app-propgrid .app-wrapper",function(t){if(t.direction.match(/left|right/)||t.direction==="down"&&t.keyCode===13){var r=t.textInput,i=r.closest("[data-property]");if(i.length)return setTimeout(function(){r.blur();n.scrollIntoView(i);n.hasFocus(i.find('[data-control="field"]'));n.scrollable("focus")}),!1}else return!1}).on("keyboardnavigation.app",".app-propgrid .app-wrapper",function(t){var u=t.direction,f=$(".app-data-input"),i;if(!f.length&&(i=n.activePage('[data-control="label"].app-has-focus,[data-container="row"][data-category].app-has-focus'),u.match(/^(up|down|left|right|enter|tab|end|home|edit)$/))){if(u=="end"&&(i=n.activePage('[data-control="label"]:visible,[data-container="row"][data-category]:visible').last()),i.length||(u="home"),i.length&&u!=="home"||(i=n.activePage('[data-control="label"]:visible,[data-container="row"][data-category]:visible').first()),!i)return;if(i=i.closest('[data-container="row"]'),u==="edit"&&!i.is("[data-category]"))return r.focus({field:i.data("property")}),!1;if(u==="tab")if(i.is("[data-category]"))u=t.originalEvent.shiftKey?"up":"down";else return r.focus({field:i.data("property")}),!1;if(u==="enter")if(i.is(".app-complex,[data-category]"))u=i.is(".app-collapsed")?"right":"left";else return!1;if(u==="left")if(u="up",i.is(".app-complex")){if(!i.is(".app-collapsed"))return h.apply(i[0],{}),!1}else if(i.is("[data-category]")&&!i.is(".app-collapsed"))return i.find(".app-toggle").trigger("vclick"),!1;if(u==="right")if(u="down",i.is(".app-complex")){if(i.is(".app-collapsed"))return h.apply(i[0],{}),!1}else if(i.is("[data-category]")&&i.is(".app-collapsed"))return i.find(".app-toggle").trigger("vclick"),!1;return(u==="up"||u==="down")&&(i=u==="up"?i.prevAll('[data-container="row"]:visible'):i.nextAll('[data-container="row"]:visible')),i=i.first(),i.length&&(i.is("[data-category]")?b(i):i.is("[data-property]")&&(i=i.find('[data-control="field"]'),n.hasFocus(i),n.saveLastFocusedField(i),i.closest('[data-container="row"]')),n.scrollIntoView(i)),!1}}).on("keyboardpreview.app",".app-propgrid .app-wrapper",function(t){var i=$(document.activeElement);if(t.originalEvent.key==="F1"&&$(this).find('[data-control="label"].app-has-focus').length)return n.activePage(".app-infopane .app-help").trigger("mousedown"),!1;if(!i.is(":input")&&(i=$(this).find('[data-control="label"].app-has-focus'),i.length)){var f=t.originalEvent,u=f.key||"",e=i.data("field");(u.length===1&&!f.ctrlKey||u.match(/Backspace|Del|Delete/))&&(u.length>1?r.execute({values:[{field:e,value:null}]}):r._buffer=u,t.preventDefault(),r.focus({field:e}))}}).on("paste",function(t){var i=$(document.activeElement),u,f;if(!i.is(":input")&&n.activePage().is(".app-propgrid")&&(i=$(this).find('[data-control="label"].app-has-focus'),i.length))return u=i.data("field"),f=t.originalEvent.clipboardData.getData("text/plain"),r._buffer=f,r.focus({fieldName:u}),!1}).on("propgridinit.app",function(){var r=n.activePage(),e=n.bar("create",{type:"header",page:r}),v=n.bar("create",{type:"footer",page:r}),s=o("app-toolbar").appendTo(e),u=o("app-infopane").appendTo(v),h=o("app-title").appendTo(u),c,a,i;l("app-text").appendTo(h);o("app-description").appendTo(u);f().helpUrl&&n.icon("material-icon-help_outline",h).addClass("app-help").attr({title:Web.MembershipResources.Bar.HelpLink,"data-tooltip-location":"above"}).hide();c=l("app-btn app-btn-categorized").appendTo(s).toggleClass("app-selected",!0).attr("title","Categorized");n.icon("material-icon-category",c);a=l("app-btn app-btn-alphabetical").appendTo(s).toggleClass("app-selected",!1).attr("title","Alphabetical");n.icon("material-icon-sort_by_alpha",a);n.bar("show",e);n.bar("show",u);r.data("infoPane",u);i=t.userVar("PropGrid.LastSelected");i&&(i=i.split(/\$/),f().context===i[0]&&(property=r.find('[data-property="'+i[1]+'"]:visible'),property.find('[data-control="label"]').trigger("vclick")))}).on("mousedown pointerdown touchstart",".app-propgrid .app-infopane .app-help",function(){var t=g(n.activePage("[data-property] .app-has-focus")),r=f().helpUrl,i=[];if(t&&r){for(r.endsWith("/")||(r=r+="/");t;)if(t.parent)i.splice(0,0,t.name),t.parent.parent&&i.splice(0,0,"."),t=t.parent;else{i.splice(0,0,t.scope,"/");break}i.splice(0,0,r);i=i.join("").toLowerCase();window.open(i,"propgridhelp_"+f().context.replace(/\W/g,"_"))}return!1})})();